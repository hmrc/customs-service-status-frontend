@*
 * Copyright 2025 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import uk.gov.hmrc.customsservicestatusfrontend.models.State
@import uk.gov.hmrc.customsservicestatusfrontend.models.State.*
@import uk.gov.hmrc.customsservicestatusfrontend.utils.Formatters
@import uk.gov.hmrc.govukfrontend.views.html.components.*
@import uk.gov.hmrc.govukfrontend.views.viewmodels.insettext.InsetText
@import uk.gov.hmrc.customsservicestatusfrontend.controllers.routes
@import uk.gov.hmrc.customsservicestatusfrontend.models.OutageData
@import uk.gov.hmrc.customsservicestatusfrontend.models.DetailType

@import java.time.Instant

@this(layout: govukLayoutFullWidth, govukInsetText : GovukInsetText)

@(state: State, stateChangedAt: Instant, serviceId: String, unplannedOutageData: Option[OutageData], plannedWorksHappeningToday: List[OutageData])(implicit request: RequestHeader, messages: Messages)

@statusClass = @{
     if(state == AVAILABLE) "govuk-tag govuk-tag--green" else if (state == UNAVAILABLE) "govuk-tag govuk-tag--orange" else ""
}

@pageTitlePrefix = @{
    if(state == AVAILABLE || state == UNAVAILABLE) {
        messages(s"dashboard.$serviceId.h1")
    } else { messages(s"dashboard.$serviceId.unknown.h1") }
}

@renderPlannedWorks(plannedWorksHappeningToday: List[OutageData]) = {
    @plannedWorksHappeningToday.map { plannedWork =>
        <p class="govuk-body">
            @Html("<b>" + Messages(s"dashboard.available.planned.p2") + "</b>" + " " + Messages(s"dashboard.available.planned.p2.fromDate", s"${Formatters.instantFormatHours(plannedWork.startDateTime)}", s" ${Formatters.instantFormatDate(plannedWork.startDateTime)}"))
        </p>
        <p class="govuk-body">
            @Html("<b>" + Messages(s"dashboard.available.planned.p3") + "</b>" + " " + Messages(s"dashboard.available.planned.p3.toDate", s"${Formatters.instantFormatHours(plannedWork.endDateTime.get)}", s" ${Formatters.instantFormatDate(plannedWork.endDateTime.get)}"))
        </p>
        <p class="govuk-body">
            @plannedWork.commsText match {
            case DetailType.CommsText(html) => {@Html("<b>" + Messages("dashboard.available.planned.p4") + "</b>" + " " + Messages(s"dashboard.available.planned.p4.details", s"${html}"))
                }
            }
        </p>
    }
}

@layout(pageTitle = Some(s"$pageTitlePrefix - ${messages("service.name")} - ${messages("service.title.suffix")}")) {

 @if(state == AVAILABLE) {
   @availableContent
 } else if(state == UNAVAILABLE) {
   @unavailableContent
 } else { @unknownContent }
}

@availableContent = {
    <h1 class="govuk-heading-l">@messages(s"dashboard.$serviceId.h1")</h1>
    <p class="govuk-heading-m">@Html(messages("dashboard.h2"))</p>
    <span class="govuk-visually-hidden-focusable" for="service-status">
        @messages("dashboard.status.screen.reader", messages(s"dashboard.status.$serviceId.longName"))
    </span>
    <strong class="@statusClass" id="service-status">
        @messages("service.state.AVAILABLE")
    </strong>
    <br>
    <br>
    <p class="govuk-body">
        <a class="govuk-link" id='refresh-link' href=@routes.DashboardController.show>@messages(s"dashboard.available.$serviceId.p1.link")</a> @messages(s"dashboard.available.$serviceId.p1")
    </p>

    @if(unplannedOutageData.isDefined) {
    <ol class="hmrc-timeline">
        <li class="hmrc-timeline__event">
            <h2 class="hmrc-timeline__event-title govuk-table__caption--s">
                @Html(messages("dashboard.available.unplanned.p1", s"<b>${Formatters.instantFormatHours(unplannedOutageData.get.publishedDateTime)}</b>", s"<b>${Formatters.instantFormatDate(unplannedOutageData.get.publishedDateTime)}</b>"))
            </h2>
            <div class="hmrc-timeline__event-content">
                    @unplannedOutageData.get.commsText match {
                        case DetailType.CommsText(html) => {@Html(html)}
                        }
            </div>
        </li>
    </ol>
    }

    @if(plannedWorksHappeningToday) {
        <p class="govuk-heading-m">@Html(messages("dashboard.h5"))</p>
            @renderPlannedWorks(plannedWorksHappeningToday)
        <br>
        <p class="govuk-heading-m">@Html(messages("dashboard.h6"))</p>
        <p class="govuk-body">
            <a class="govuk-link" id='plannedwork-link' href=@routes.PlannedWorkController.show>@messages(s"dashboard.available.$serviceId.p2")</a>
        </p>
        <p class="govuk-heading-m">@Html(messages("dashboard.h4"))</p>
        <p class="govuk-body">@optionalLink(s"dashboard.available.$serviceId.p3.link", s"dashboard.available.$serviceId.p3", "available_p3_link")</p>
    }else{
        <p class="govuk-heading-m">@Html(messages("dashboard.h3"))</p>
        <p class="govuk-body">
            <a class="govuk-link" id='plannedwork-link' href=@routes.PlannedWorkController.show>@messages(s"dashboard.available.$serviceId.p2")</a>
        </p>

        <p class="govuk-heading-m">@Html(messages("dashboard.h4"))</p>
        <p class="govuk-body">@optionalLink(s"dashboard.available.$serviceId.p3.link", s"dashboard.available.$serviceId.p3", "available_p3_link")</p>
        }
}

@unavailableContent = {
    <h1 class="govuk-heading-l">@messages(s"dashboard.$serviceId.h1")</h1>
    <p class="govuk-heading-m">@Html(messages("dashboard.h2"))</p>
    <span class="govuk-visually-hidden-focusable" for="service-status">
        @messages("dashboard.status.screen.reader", messages(s"dashboard.status.$serviceId.longName"))
    </span>
    <strong class="@statusClass" id="service-status">
        @messages("service.state.UNAVAILABLE")
    </strong>
    <br>
    <br>
    <p class="govuk-body">
        <a class="govuk-link" id='refresh-link' href=@routes.DashboardController.show>@messages(s"dashboard.unavailable.$serviceId.p1.link")</a> @messages(s"dashboard.unavailable.$serviceId.p1")
    </p>

    @if(unplannedOutageData.isDefined) {
        <ol class="hmrc-timeline">
            <li class="hmrc-timeline__event">
                <h2 class="hmrc-timeline__event-title govuk-table__caption--s">
                    @Html(messages("dashboard.unavailable.unplanned.p1", s"<b>${Formatters.instantFormatHours(unplannedOutageData.get.publishedDateTime)}</b>", s"<b>${Formatters.instantFormatDate(unplannedOutageData.get.publishedDateTime)}</b>"))
                </h2>
                <div class="hmrc-timeline__event-content">
                    @unplannedOutageData.get.commsText match {
                    case DetailType.CommsText(html) => {@Html(html)}
                    }
                </div>
            </li>
            <li class="hmrc-timeline__event">
                <h2 class="hmrc-timeline__event-title govuk-table__caption--s">
                    @Html(messages("dashboard.unavailable.issues_with_the_service.h1", s"<b>${Formatters.instantFormatHours(unplannedOutageData.get.publishedDateTime)}</b>", s"<b>${Formatters.instantFormatDate(unplannedOutageData.get.publishedDateTime)}</b>"))
                </h2>
            </li>
        </ol>
    }else{
        <ol class="hmrc-timeline">
            <li class="hmrc-timeline__event">
                <h2 class="hmrc-timeline__event-title govuk-table__caption--s">
                    @Html(messages("dashboard.unavailable.issues_with_the_service.h1", s"<b>${Formatters.instantFormatHours(Instant.now)}</b>", s"<b>${Formatters.instantFormatDate(Instant.now)}</b>"))
                </h2>
                <div class="hmrc-timeline__event-content">
                    <p class="govuk-body">
                        @Html(messages("dashboard.unavailable.issues_with_the_service.p1"))
                    </p>
                <div class="hmrc-timeline__event-content">
                    <p class="govuk-body">
                        @Html(messages("dashboard.unavailable.issues_with_the_service.p2"))
                    </p>
                </div>
                </div>
            </li>
        </ol>
    }

    @if(plannedWorksHappeningToday) {
        <p class="govuk-heading-m">@Html(messages("dashboard.h5"))</p>
            @renderPlannedWorks(plannedWorksHappeningToday)
        <br>
        <p class="govuk-heading-m">@Html(messages("dashboard.h6"))</p>
        <p class="govuk-body">
            <a class="govuk-link" id='plannedwork-link' href=@routes.PlannedWorkController.show>@messages(s"dashboard.available.$serviceId.p2")</a>
        </p>
        <p class="govuk-heading-m">@Html(messages("dashboard.h4"))</p>
        <p class="govuk-body">@optionalLink(s"dashboard.unavailable.$serviceId.p3.link", s"dashboard.unavailable.$serviceId.p3", "unavailable_p3_link")</p>
        }else{
        <p class="govuk-heading-m">@Html(messages("dashboard.h3"))</p>
        <p class="govuk-body">
            <a class="govuk-link" id='plannedwork-link' href=@routes.PlannedWorkController.show>@messages(s"dashboard.available.$serviceId.p2")</a>
        </p>

        <p class="govuk-heading-m">@Html(messages("dashboard.h4"))</p>
        <p class="govuk-body">@optionalLink(s"dashboard.available.$serviceId.p3.link", s"dashboard.unavailable.$serviceId.p3", "unavailable_p3_link")</p>
    }
}

@optionalLink(linkMsgKey: String, linkTextKey: String, anchorId: String) = @{
    Option(messages(linkMsgKey)).filter(_.nonEmpty).fold(Html(""))(link(_, linkTextKey, anchorId))
}

@link(url: String, linkTextKey: String, anchorId: String) = {<a id="@anchorId" href="@url" class="govuk-link govuk-link--no-visited-state">@messages(linkTextKey)</a>}

@unknownContent = {
    <h1 class="govuk-heading-l">@messages(s"dashboard.$serviceId.unknown.h1")</h1>
    <p class="govuk-body">@messages(s"dashboard.$serviceId.unknown.p1")</p>
    <p class="govuk-body">@Html(messages(s"dashboard.$serviceId.unknown.p2", optionalLink(s"dashboard.status.unknown.$serviceId.link", s"dashboard.$serviceId.link_text", "service_url")))</p>
}
